import{ai as a,al as v,N as u,am as p,an as y}from"./index.b078bf5f.js";import{C as B}from"./5e635fe2.js";class C extends B{FEA_CMD_SET_NORDIC_BOOT=67;FEA_CMD_GET_NORDIC_BOOT=195;FEA_CMD_SET_NORDIC_BOOTSTART=68;FEA_CMD_GET_NORDIC_BOOTSTART=196;FEA_CMD_GET_RF_VERSION=197;getDeviceIsBoot=async()=>{const t=await this.commonMsg(new Uint8Array([143]),a.Bit7);return t!==void 0&&t[9]===1};BOOT_INFOS=[{vid:12625,pid:20516},{vid:12625,pid:20522}];boot_usb=async()=>{if(this.BOOT_INFOS.some(e=>e.vid===this.deviceType.vid&&e.pid===this.deviceType.pid))return this.deviceType.devAddr.toString();await this.sendMsg(new Uint8Array([127,85,170,85,170]),a.Bit7),await v(1e3*1);let t=0,i;for(;i===void 0&&t<100;)await v(500),i=u.devlistList.find(e=>e.oneofDev.oneofKind==="dev"&&e.oneofDev.dev.devType===p.YZWBoot&&this.BOOT_INFOS.some(n=>e.oneofDev.oneofKind==="dev"&&n.vid===e.oneofDev.dev.vid&&n.pid===e.oneofDev.dev.pid)),t++;if(!(i===void 0||i.oneofDev.oneofKind!=="dev"))return i.oneofDev.dev.path};findSameDevPath=async()=>{let t=0,i;for(;i===void 0&&t<20;){await v(500);const e=u.devlistList.find(n=>n.oneofDev.oneofKind==="dev"&&(n.oneofDev.dev.path===this.deviceType.devAddr||n.oneofDev.dev.id===this.deviceType.id||n.oneofDev.dev.id===-1));i=e?.oneofDev.oneofKind==="dev"?e.oneofDev.dev.path:void 0,t++}if(i!==void 0)return i};boot_rf=async()=>{const t=await this.findSameDevPath();if(t===void 0)return;await v(100),await this.sendMsgByPath(new Uint8Array([this.FEA_CMD_SET_NORDIC_BOOT,85,170,85,170,0,0,0]),a.Bit7,t),await v(1e3*3);let i=0,e=!1;for(;!e&&i<10;){i++;const n=await this.commonMsgByPath(new Uint8Array([this.FEA_CMD_GET_NORDIC_BOOT]),a.Bit7,t,10,100);e=n!==void 0&&n[1]===1,await v(1e3)}if(e)return t};rfUpgrade=async(t,i)=>{if(i(0),this.deviceType.isBoot&&this.BOOT_INFOS.some(o=>o.vid===this.deviceType.vid&&o.pid===this.deviceType.pid))return!1;const e=await this.boot_rf();if(e===void 0)return!1;const n=t;i(0);const s=n.slice(65536),d=64,f=Math.ceil(s.length/d),c=new Uint8Array(2);c[0]=f&255,c[1]=f>>8;const _=[this.FEA_CMD_SET_NORDIC_BOOTSTART];c.map(o=>_.push(o)),await this.sendMsgByPath(new Uint8Array(_),a.Bit7,e);let r=0;for(let o=0;o<f;o++){const D=o*d>s.length?d-(o*d-s.length):d,O=s.slice(o*d,o*d+D);if(!await this.sendMsgByPath(O,a.None,e))return!1;r+=y([...O]),i(o/f)}const h=[this.FEA_CMD_GET_NORDIC_BOOTSTART];h.push(r&255),h.push((r&65280)>>8),h.push((r&16711680)>>16),h.push((r&4278190080)>>24);const T=await this.commonMsgByPath(new Uint8Array(h),a.None,e);return T!==void 0&&T[1]===85};upgrade=async(t,i)=>{if(i(0),this.deviceType.isBoot&&!this.BOOT_INFOS.some(s=>s.vid===this.deviceType.vid&&s.pid===this.deviceType.pid))return!1;const e=await this.boot_usb();return e===void 0?!1:await this.upgrade_dev(t,e,65536,i)}}export{C};
