import{ad as A,N as h,ai as r,al as m,m as C,an as T}from"./index.b078bf5f.js";class B extends A{type="dongle";defaultMatrix=[];getUSBVersion=async()=>{const n=h.devlistList.find(t=>t.oneofDev.oneofKind==="dangleCommonDev"&&(t.oneofDev.dangleCommonDev.pid===16429||t.oneofDev.dangleCommonDev.pid===20487)&&t.oneofDev.dangleCommonDev.vid===12625);let e;if(n!=null&&n.oneofDev.oneofKind==="dangleCommonDev"){const t=n.oneofDev.dangleCommonDev?.path;e=await this.commonMsgByPath(new Uint8Array([240]),r.Bit7,t,5,0)}if(e!==void 0)return e[2]===0?parseInt(e[1].toString(),16):parseInt((e[2]<<8).toString(),10)};getRFVersion=async()=>{const n=h.devlistList.find(t=>t.oneofDev.oneofKind==="dangleCommonDev"&&(t.oneofDev.dangleCommonDev.pid===16429||t.oneofDev.dangleCommonDev.pid===20487)&&t.oneofDev.dangleCommonDev.vid===12625);h.changeWirelessLoopStatus("stop");let e;if(n!=null&&n.oneofDev.oneofKind==="dangleCommonDev"){const t=n.oneofDev.dangleCommonDev?.path;e=await this.commonMsgByPath(new Uint8Array([251]),r.Bit7,t,5,0)}return e===void 0?0:e[3]<200?parseInt(e[3].toString(),16):parseInt(e[3].toString(),10)};getMledVersion=async()=>{};setLightSetting=async n=>!1;getLightSetting=async()=>{};reset=async()=>!1;getDeviceIsBoot=async()=>{const n=h.devlistList.find(e=>e.oneofDev.oneofKind==="dangleCommonDev"&&(e.oneofDev.dangleCommonDev.pid===16429||e.oneofDev.dangleCommonDev.pid===20487)&&e.oneofDev.dangleCommonDev.vid===12625);if(n!=null&&n.oneofDev.oneofKind==="dangleCommonDev"){const e=n.oneofDev.dangleCommonDev?.path;let t=0,o=!1;for(;!o&&t<30;){t++;const i=await this.commonMsgByPath(new Uint8Array([247]),r.Bit7,e);o=i!==void 0&&i[8]===1,await m(100)}return o}return!1};flashUpgrade=async(n,e)=>!1;getOLEDDataDirection=()=>"col";sendRawMsg=async(n,e,t=10)=>await this.sendMsgByPath(n,e,this.deviceType.devAddr.toString(),t);commonRawMsg=async(n,e,t,o)=>await this.commonMsgByPath(n,e,this.deviceType.devAddr.toString(),t,o);FEA_CMD_GETOLED_VERSION=173;getOledVersion=async()=>{h.changeWirelessLoopStatus("stop");const n=await this.commonRawMsg(new Uint8Array([this.FEA_CMD_GETOLED_VERSION]),r.Bit7,10,100);if(n===void 0||n[0]!==this.FEA_CMD_GETOLED_VERSION)return;const e=new DataView(n.buffer,n.byteOffset,n.byteLength);return{oledVersion:e.getUint16(1,!0),flashVersion:e.getUint16(3,!0)}};FEA_CMD_GETTFTLCDDATA=165;FEA_CMD_GET_SCREEN_24BITDATA=169;getTFTLCDDataRGBImg=async(n,e,t)=>{await this.commonRawMsg(new Uint8Array([247]),r.Bit7,10,10);const o=new Uint8Array(64);o[0]=n==="16"?this.FEA_CMD_GETTFTLCDDATA:this.FEA_CMD_GET_SCREEN_24BITDATA,o[1]=e.currentFrame,o[2]=e.frameNum,o[3]=e.frameDelay;const i=e.data.length;o[4]=i&255,o[5]=(i&65535)>>8,o[6]=0,o[8]=e.left&255,o[9]=e.top&255,o[10]=e.right&255,o[11]=e.bottom&255,o[12]=e.left>>8,o[13]=e.top>>8,o[14]=e.right>>8,o[15]=e.bottom>>8,o[16]=(i&16777215)>>16,o[17]=(i&4294967295)>>24,o[18]=t??0;let s=!1,a=0;for(;a<10&&!s;){await m(100);const D=await this.commonRawMsg(o,r.Bit7,10,100);s=D!==void 0&&D[1]===1,a++}return await m(100),s};FEA_CMD_SETTFTLCDDATA=37;FEA_CMD_SET_SCREEN_24BITDATA=41;setTFTLCDDataRGBImg=async(n,e,t)=>{const o=Math.ceil(e.data.length/56),i=new Uint8Array(8);i[0]=n==="16"?this.FEA_CMD_SETTFTLCDDATA:this.FEA_CMD_SET_SCREEN_24BITDATA,i[1]=e.currentFrame,i[2]=e.frameNum,i[3]=e.frameDelay;for(let s=0;s<o;s++){let a=[...e.data.slice(s*56,s*56+56)];const D=a.length;D<56&&(a=[...a,...new Array(56-a.length).fill(0)]),i[4]=s&255,i[5]=s>>8,i[6]=D;const f=new Uint8Array([...i,...a]);await m(2);const c=await this.sendRawMsg(f,r.Bit7,1);if(t&&t(s/o),!c)return!1}return t&&t(1),!0};FEA_CMD_SET_OLEDCLOCK=40;setOLEDClock=async()=>{const n=new Uint8Array(64);n[0]=this.FEA_CMD_SET_OLEDCLOCK;let e="";try{const t=window.require("child_process");C.getPlatform()!=="mac"?e=t.spawnSync("powershell.exe",["get-date -format 'yyyy,MM,dd,HH,mm,ss'"],{encoding:"utf8"}).stdout:e=t.execSync('date +"%Y,%m,%d,%H,%M,%S"').toString()}catch{}if(e!=""&&e!=null){const t=e.split(","),o=Number(t[0]);n[8]=o>>8,n[9]=o&255,n[10]=Number(t[1]),n[11]=Number(t[2]),n[12]=Number(t[3]),n[13]=Number(t[4]),n[14]=Number(t[5])}else{const t=new Date,o=t.getFullYear();n[8]=o>>8,n[9]=o&255,n[10]=t.getMonth()+1,n[11]=t.getDate(),n[12]=t.getHours(),n[13]=t.getMinutes(),n[14]=t.getSeconds()}return await this.sendRawMsg(n,r.Bit7,0)};FEA_CMD_SET_FLASHCHIPERASSE=172;setFlashChipErase=async()=>{const n=new Uint8Array(64);n[0]=this.FEA_CMD_SET_FLASHCHIPERASSE;const e=await this.commonRawMsg(n,r.Bit7);return e===void 0?!1:e[0]===this.FEA_CMD_SET_FLASHCHIPERASSE&&e[1]===170&&e[2]===170&&e[3]===85&&e[4]===85};FEA_CMD_SET_MENU=47;setScreenMenu=async n=>{const e=new Uint8Array(64);return e[0]=this.FEA_CMD_SET_MENU,e[1]=n.menu?1:0,e[2]=n.time,await this.sendRawMsg(e,r.Bit7,0)};FEA_CMD_GET_MENU=175;findSameDevPath=async n=>{let e=0,t;for(;t===void 0&&e<20;){await m(500);const o=h.devlistList.find(i=>i.oneofDev.oneofKind==="dangleCommonDev"&&(i.oneofDev.dangleCommonDev.path===this.deviceType.devAddr||(i.oneofDev.dangleCommonDev.pid===16429||i.oneofDev.dangleCommonDev.pid===20487)&&i.oneofDev.dangleCommonDev.vid===12625));t=o?.oneofDev.oneofKind==="dangleCommonDev"?o.oneofDev.dangleCommonDev.path:void 0,e++}if(t!==void 0)return t};FEA_CMD_SET_OLEDBOOTLOADER=48;FEA_CMD_GET_OLEDBOOTLOADER=176;FEA_CMD_SET_OLEDBOOTSTART=49;FEA_CMD_GET_OLEDBOOTCHECKSUM=177;oledUpgrade=async(n,e)=>{e(0);const t=await this.findSameDevPath();if(t===void 0||!await this.sendMsgByPath(new Uint8Array([this.FEA_CMD_SET_OLEDBOOTLOADER,85,170,85,170,0,0,0]),r.Bit7,t))return!1;let i=0,s=!1;for(;!s&&i<5;){await m(1e3*3);const l=await this.commonMsgByPath(new Uint8Array([this.FEA_CMD_GET_OLEDBOOTLOADER]),r.Bit7,t,10,100);s=l!==void 0&&l[0]===this.FEA_CMD_GET_OLEDBOOTLOADER,i++}const a=n.slice(65536),D=64,f=Math.ceil(a.length/D),c=new Uint8Array(2);c[0]=f&255,c[1]=f>>8,await this.sendMsgByPath(new Uint8Array([this.FEA_CMD_SET_OLEDBOOTSTART,...c]),r.Bit7,t);let v=0;for(let l=0;l<f;l++){const _=l*D>a.length?D-(l*D-a.length):D,E=a.slice(l*D,l*D+_),d=await this.sendMsgByPath(E,r.None,t);for(let w=0;w<E.length;w++)v+=E[w];if(d)e(l/f);else return e(1),!1}const g=new Uint8Array(4);g[0]=v&255,g[1]=(v&65280)>>8,g[2]=(v&16711680)>>16,g[3]=(v&4278190080)>>24;const u=await this.commonMsgByPath(new Uint8Array([this.FEA_CMD_GET_OLEDBOOTCHECKSUM,...g]),r.Bit7,t,10,1e3*1);return e(1),u!==void 0&&u[1]===85};upgrade_dev=async(n,e,t,o)=>{const i=n.slice(t),s=64,a=Math.ceil(i.length/s),D=new Uint8Array(2);D[0]=a&255,D[1]=a>>8;const f=new Uint8Array(4);f[0]=i.length&255,f[1]=(i.length&65280)>>8,f[2]=(i.length&16711680)>>16,f[3]=(i.length&4278190080)>>24;const c=[186,192];D.map(d=>c.push(d)),f.slice(0,3).map(d=>c.push(d));let v,g=0;for(;v===void 0&&g<10;)v=await this.commonMsgByPath(new Uint8Array(c),r.None,e),g++,await m(1e3);if(v===void 0)return!1;for(let d=0;d<a;d++){const w=d*s>i.length?s-(d*s-i.length):s,y=i.slice(d*s,d*s+w);if(!await this.sendMsgByPath(y,r.None,e))return!1;o(d/a)}const u=T([...i]),l=new Uint8Array(4);l[0]=u&255,l[1]=(u&65280)>>8,l[2]=(u&16711680)>>16,l[3]=(u&4278190080)>>24;const _=[186,194];D.map(d=>_.push(d)),l.map(d=>_.push(d)),f.map(d=>_.push(d));const E=await this.commonMsgByPath(new Uint8Array(_),r.None,e,50,10);return E!==void 0&&E[4]===85};BOOT_INFOS=[{vid:12625,pid:16430}];boot_usb=async()=>{if(this.BOOT_INFOS.some(o=>o.vid===this.deviceType.vid&&o.pid===this.deviceType.pid))return this.deviceType.devAddr.toString();const n=h.devlistList.find(o=>o.oneofDev.oneofKind==="dangleCommonDev"&&(o.oneofDev.dangleCommonDev.pid===16429||o.oneofDev.dangleCommonDev.pid===20487)&&o.oneofDev.dangleCommonDev.vid===12625);if(n!=null&&n.oneofDev.oneofKind==="dangleCommonDev"){const o=n.oneofDev.dangleCommonDev?.path;await this.sendMsgByPath(new Uint8Array([127,85,170,85,170]),r.Bit7,o)}await m(1e3*1);let e=0,t;for(;t===void 0&&e<100;)await m(500),t=h.devlistList.find(o=>o.oneofDev.oneofKind==="dev"&&o.oneofDev.dev.devType===1&&o.oneofDev.dev.pid===16430&&o.oneofDev.dev.vid===12625),e++;if(!(t===void 0||t.oneofDev.oneofKind!=="dev"))return t.oneofDev.dev.path};upgrade=async(n,e)=>{e(0);const t=await this.boot_usb();if(t===void 0)return!1;const o=await this.upgrade_dev(n,t,20480,e);return e(1),o};boot_rf=async()=>{let n,e=0;for(;n===void 0&&e<20;)await m(500),n=h.devlistList.find(a=>a.oneofDev.oneofKind==="dangleCommonDev"&&(a.oneofDev.dangleCommonDev.pid===16429||a.oneofDev.dangleCommonDev.pid===20487)&&a.oneofDev.dangleCommonDev.vid===12625),e++;if(n===void 0||n.oneofDev.oneofKind!=="dangleCommonDev")return;let t=n.oneofDev.dangleCommonDev.path;const o=await this.commonMsgByPath(new Uint8Array([247]),r.Bit7,t);if(o!==void 0&&o[8]===1&&o[7]===1)return t;await m(100),await this.sendMsgByPath(new Uint8Array([248,85,170,85,170,0,0,130]),r.Bit7,t),await m(2e3);let i=0,s=!1;for(;!s&&i<10;){i++;const a=await this.commonMsgByPath(new Uint8Array([247]),r.Bit7,t);s=a!==void 0&&a[8]===1&&a[7]===1,await m(100)}if(s)return t};rfUpgrade=async(n,e)=>{e(0);const t=await this.boot_rf();if(t===void 0)return!1;const o=await this.upgrade_dev(n,t,65536,i=>e(i));if(o){await m(2e3);let i=!1,s=0;for(;!i&&s<10;){const a=await this.commonMsgByPath(new Uint8Array([247]),r.Bit7,t);s++,i=a!==void 0&&a[8]===0&&a[7]===0,i||await m(100)}return e(1),i}return e(1),o}}export{B as CommonDongle};
