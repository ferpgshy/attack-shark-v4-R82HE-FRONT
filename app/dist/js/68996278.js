import{a8 as W,a as H,G as _,ax as ne,aL as se,ao as J,ap as U,j as o,V as h,c as X,a9 as V,aM as ie,r as w,d as t,u as re,aN as ae,aO as le,I,P as T,H as ce,社 as de,aP as ue,Z as Q,l as pe,e as Z,aQ as ye,y as ee,F as N,aR as $,aj as D,a4 as fe,a5 as te}from"./index.b078bf5f.js";import{_ as ge}from"./b9147315.js";import{R as G}from"./18d64e70.js";import{S as xe}from"./9cc765b4.js";import"./eb259a23.js";const me={cell_macro_坐标:{type:"svg",str:await W(()=>import("./ec0ad99d.js"),[],import.meta.url).then(r=>r.default),id:{default:{text_x:"text",text_y:"text"}}}},he={cell_macro_延迟:{type:"svg",str:await W(()=>import("./3326388a.js"),[],import.meta.url).then(r=>r.default),id:{default:{title:"text"}}}},ve={cell_macro_按键:{type:"svg",str:await W(()=>import("./ec7d5c4f.js"),[],import.meta.url).then(r=>r.default),id:{default:{title:"text",dn:"path",up:"path"},hover:{title:"text",dn:"path",up:"path"}}}},be={cell_macro_按键_鼠标:{type:"svg",str:await W(()=>import("./f9daae75.js"),[],import.meta.url).then(r=>r.default),id:{default:{icon_macro_mouse:"g",dn:"path",up:"path"},hover:{icon_macro_mouse:"g",dn:"path",up:"path"}}}},Y=r=>{const{targetElement:v,menuElement:p,items:e}=r;if(p.children.length>0){const y=p.children;Array.from(y).forEach(l=>{const f=l,i=f.getAttribute("data-direction");let s="";switch(i){case"top":s="translate(-50%, 20px)";break;case"right":s="translate(-25px -50%)";break;case"bottom":s="translate(-50%, -20px)";break}f.style.opacity="0",f.style.transform=s}),setTimeout(()=>{p.innerHTML=""},200);return}p.innerHTML="";const c=v.getBoundingClientRect();e.forEach(y=>{const l=document.createElement("div");l.setAttribute("data-direction",y.direction),Object.assign(l.style,{position:"absolute",backgroundColor:"#FFFFFF",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",borderRadius:"4px",padding:"8px 12px",cursor:"pointer",fontSize:"14px",color:"#333333",zIndex:"99999",whiteSpace:"nowrap",opacity:"0",transition:"all 0.2s cubic-bezier(0.4, 0, 0.2, 1)"}),l.innerText=y.text;let f="",i="";switch(y.direction){case"top":l.style.left=`${c.left+c.width/2}px`,l.style.top=`${c.top-40}px`,f="translate(-50%, 20px)",i="translate(-50%, 0)";break;case"right":l.style.left=`${c.right+10}px`,l.style.top=`${c.top+c.height/2}px`,f="translate(-20px, -50%)",i="translate(-20px 0,50%)";break;case"bottom":l.style.left=`${c.left+c.width/2}px`,l.style.top=`${c.bottom+10}px`,f="translate(-50%, -20px)",i="translate(-50%, 0)";break}l.style.transform=f,p.appendChild(l),requestAnimationFrame(()=>{l.style.opacity="1",l.style.transform=i}),l.addEventListener("mouseenter",()=>{if(l.style.backgroundColor="#F5F5F5",y.children){const s=document.createElement("div");Object.assign(s.style,{position:"absolute",backgroundColor:"#FFFFFF",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",borderRadius:"4px",padding:"4px 0",opacity:"0",transition:"all 0.15s cubic-bezier(0.4, 0, 0.2, 1)"}),y.direction==="right"?(s.style.left="100%",s.style.top="0",s.style.transform="translateX(-10px)"):(s.style.left="100%",s.style.top="auto",s.style.bottom="0",s.style.transform="translateX(-10px)"),y.children.forEach(S=>{const n=document.createElement("div");Object.assign(n.style,{padding:"8px 16px",cursor:"pointer",fontSize:"14px",color:"#333333",transition:"background-color 0.15s"}),n.innerText=S.text,n.addEventListener("mouseenter",()=>{n.style.backgroundColor="#F5F5F5"}),n.addEventListener("mouseleave",()=>{n.style.backgroundColor="transparent"}),n.addEventListener("click",()=>{S.onClick(),p.innerHTML=""}),s.appendChild(n)}),l.appendChild(s),requestAnimationFrame(()=>{s.style.opacity="1",s.style.transform=y.direction==="right"?"translateX(0)":"translateY(0)"})}}),l.addEventListener("mouseleave",()=>{l.style.backgroundColor="#FFFFFF"}),y.children||l.addEventListener("click",()=>{l.style.transform=f,l.style.opacity="0",setTimeout(()=>{y.onClick&&y.onClick(),p.innerHTML=""},150)})});const C=y=>{if(!p.contains(y.target)&&!v.contains(y.target)){const l=p.children;Array.from(l).forEach(f=>{const i=f,s=i.getAttribute("data-direction");let S="";switch(s){case"top":S="translate(-50%, 20px)";break;case"right":S="translate(-20px, -50%)";break;case"bottom":S="translate(-50%, -20px)";break}i.style.opacity="0",i.style.transform=S}),setTimeout(()=>{p.innerHTML="",document.removeEventListener("mousedown",C)},200)}};document.addEventListener("mousedown",C)},oe=r=>{const v=H(),p=_(),e=_(),c=_(),C=ne(p),{multilingualKeyCodeToDisplayText_wrap:y}=se();return J({ref:c,onInit:l=>{const f=U(ve).cell_macro_按键(l);if("title"in f.root){const i=f.root.querySelector("title");if(!i)return;Object.assign(i.style,{fontSize:"clamp(0.75rem, 1rem, 1.25rem)",fontWeight:"500",lineHeight:"1.2",whiteSpace:"break-spaces",textAlign:"center",dominantBaseline:"middle",alignmentBaseline:"middle",width:"100%"})}return f},onRefresh:l=>{const f=l?.show(s=>C?s.hover:s.default);if(!f)return;f.id.dn.style.display=r.isDown?"":"none",f.id.up.style.display=r.isDown?"none":"";const i=y[r.value]||"";if("title"in f.id){const s=f.id.title;for(;s.firstChild;)s.removeChild(s.firstChild);const S=i.split(`
`),n=Math.max(...S.map(d=>d.length)),E=S.length,L=Math.max(.6,1.2-E*.2),z=Math.max(.6,6/n),a=`${Math.min(L,z)}rem`;s.setAttribute("text-anchor","middle"),s.setAttribute("dominant-baseline","middle"),s.setAttribute("x","50%"),s.setAttribute("y",S.length>1?"25%":"40%"),S.forEach((d,b)=>{const k=document.createElementNS("http://www.w3.org/2000/svg","tspan");k.setAttribute("x","50%"),k.setAttribute("dy",b===0?"0":"1.2em"),k.style.fontSize=a,k.textContent=d,s.appendChild(k)})}}}),o.jsxs(h,{id:"cell-macro-按键",divRef:p,type:"左右___主轴居中",onClick:l=>{X.宏编辑.isRecord==="stop"&&Y({targetElement:p.current,menuElement:e.current,items:[{text:v.添加,direction:"top",children:[{text:v.按键,onClick:()=>r.onAddEvent("key")},{text:v.坐标,onClick:()=>r.onAddEvent("position")}]},{text:v.修改,direction:"right",onClick:()=>r.onChange()},{text:v.删除,direction:"bottom",onClick:()=>r.onDelete()}]})},style:{cursor:"pointer",WebkitUserSelect:"none",userSelect:"none"},onMouseDown:l=>{l.button===2&&l.preventDefault()},children:[o.jsx(h,{divRef:c}),o.jsx(h,{divRef:e,w:0,h:0})]})},we=r=>{const v=H(),p=_(),e=_(),c=_(),C=ne(p);return J({ref:c,onInit:y=>U(be).cell_macro_按键_鼠标(y).map(l=>{const f=l.root.querySelector("g:first-child[id]"),i=V.svg_create_element("g",{transform:"translate(19, 7)"});f?.appendChild(i);const s=U(ge).icon_macro_mouse(i);return l.id.icon_macro_mouse.remove(),{iconMacroMouse:s}}),onRefresh:y=>{const l=y.show(S=>C?S.hover:S.default);l.id.dn.style.display=r.isDown?"":"none",l.id.up.style.display=r.isDown?"none":"";const f=ie[r.macroMouseType],i=l.ext?.iconMacroMouse,s=i?.status[f];s&&(i.hideAll(),V.show(s.root))}}),o.jsxs(h,{id:"cell-macro-按键-鼠标",divRef:p,type:"左右___主轴居中",onClick:y=>{X.宏编辑.isRecord==="stop"&&Y({targetElement:p.current,menuElement:e.current,items:[{text:v.添加,direction:"top",children:[{text:v.按键,onClick:()=>r.onAddEvent("key")},{text:v.坐标,onClick:()=>r.onAddEvent("position")}]},{text:v.修改,direction:"right",onClick:()=>r.onChange()},{text:v.删除,direction:"bottom",onClick:()=>r.onDelete()}]})},style:{cursor:"pointer",WebkitUserSelect:"none",userSelect:"none"},onMouseDown:y=>{y.button===2&&y.preventDefault()},children:[o.jsx(h,{divRef:c}),o.jsx(h,{divRef:e,w:0,h:0})]})},Se=r=>{const v=H(),p=_(),e=_(),c=_(),[C,y]=w.useState(!1),[l,f]=w.useState(r.value);return w.useEffect(()=>{r.value!==void 0&&f(Number(r.value))},[r.value]),J({ref:c,onInit:i=>U(he).cell_macro_延迟(i),onRefresh:i=>{const s=i.show(S=>S.default);V.setText(s.id.title,`${l}`)}}),w.useEffect(()=>{if(C){const i=s=>{p.current&&!p.current.contains(s.target)&&(y(!1),r.onChange(Number(l)))};return document.addEventListener("mousedown",i),()=>document.removeEventListener("mousedown",i)}},[C,l]),o.jsxs(h,{id:"cell-macro-延迟",divRef:p,type:"左右___主轴居中",onClick:i=>{if(X.宏编辑.isRecord==="stop"){if(i.target.closest('[id="value-display"]')){y(!0);return}if(C)return;Y({targetElement:p.current,menuElement:e.current,items:[{text:v.添加,direction:"top",children:[{text:v.按键,onClick:()=>r.onAddEvent("key")},{text:v.坐标,onClick:()=>r.onAddEvent("position")}]},{text:v.修改,direction:"right",onClick:()=>y(!0)},{text:v.删除,direction:"bottom",onClick:()=>r.onDelete()}]})}},style:{cursor:"pointer",WebkitUserSelect:"none",userSelect:"none"},onMouseDown:i=>{i.button===2&&i.preventDefault()},children:[o.jsxs(h,{w:80,h:80,style:{borderRadius:12,backgroundColor:"rgb(249,249,249)",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",padding:8,textAlign:"center"},children:[o.jsx(h,{style:{textAlign:"center"},children:C?o.jsx("input",{type:"number",style:{width:"100%",height:"24px",border:"1px solid #ddd",borderRadius:"4px",outline:"none",textAlign:"center",fontSize:"14px",padding:"0 4px",backgroundColor:"#fff",transition:"border-color 0.2s"},value:l.toString(),onChange:i=>{const s=parseInt(i.target.value);s!==void 0&&!isNaN(s)&&(s<1?f(1):s>65535?f(65535):f(s))},onKeyDown:i=>{if(i.key==="Enter"){y(!1);const s=isNaN(Number(l))?1:Number(l),S=Math.max(1,Math.min(65535,s));r.onChange(S)}},onBlur:()=>{y(!1);const i=isNaN(Number(l))?1:Number(l),s=Math.max(1,Math.min(65535,i));r.onChange(s)},onFocus:i=>{i.target.style.borderColor="var(--color-highlight-2)",i.target.style.boxShadow="0 0 0 2px rgba(24, 144, 255, 0.2)"},onMouseEnter:i=>{i.target instanceof HTMLInputElement&&(i.target.style.borderColor="var(--color-highlight-2)")},onMouseLeave:i=>{document.activeElement!==i.target&&i.target instanceof HTMLInputElement&&(i.target.style.borderColor="#ddd")},autoFocus:!0}):o.jsx(h,{id:"value-display",style:{fontSize:"14px",color:"#333",cursor:"text",padding:"4px 8px",borderRadius:"4px",backgroundColor:"transparent",transition:"all 0.2s"},onMouseEnter:i=>{i.currentTarget.style.backgroundColor="rgba(0,0,0,0.05)",i.currentTarget.style.boxShadow="0 0 0 1px rgba(0,0,0,0.1)"},onMouseLeave:i=>{i.currentTarget.style.backgroundColor="transparent",i.currentTarget.style.boxShadow="none"},children:l?.toString()??"0"})}),o.jsx(h,{w:"full",h:1,style:{backgroundColor:"#ddd",margin:"8px 0"}}),o.jsx(h,{style:{textAlign:"center",fontSize:"12px",color:"#666"},children:"ms"})]}),o.jsx(h,{divRef:e,w:0,h:0})]})},Ce=r=>{const v=H(),p=_(),e=_(),c=_(),C=t.shouldAutoFocusPositionMacro,[y,l]=w.useState(C?"x":"none"),[f,i]=w.useState(r.x),[s,S]=w.useState(r.y);return w.useEffect(()=>{i(r.x),S(r.y)},[r.x,r.y]),J({ref:c,onInit:n=>U(me).cell_macro_坐标(n),onRefresh:n=>{const E=n.show(L=>L.default);V.setText(E.id.text_x,`X: ${r.x}`),V.setText(E.id.text_y,`Y: ${r.y}`)}}),w.useEffect(()=>{if(y!=="none"){const n=E=>{p.current&&!p.current.contains(E.target)&&(l("none"),r.onChange?.(f,s),t.shouldAutoFocusPositionMacro=!1)};return document.addEventListener("mousedown",n),()=>document.removeEventListener("mousedown",n)}},[y,f,s]),o.jsxs(h,{divRef:p,type:"左右___主轴居中",onClick:n=>{if(X.宏编辑.isRecord==="stop"){const E=n.target,L=E.closest('[id="value-display-x"]'),z=E.closest('[id="value-display-y"]');if(L){l("x");return}if(z){l("y");return}if(y!=="none")return;Y({targetElement:p.current,menuElement:e.current,items:[{text:v.添加,direction:"top",children:[{text:v.按键,onClick:()=>r.onAddEvent("key")},{text:v.坐标,onClick:()=>r.onAddEvent("position")}]},{text:v.修改,direction:"right",onClick:()=>l("x")},{text:v.删除,direction:"bottom",onClick:()=>r.onDelete()}]})}},style:{cursor:"pointer",WebkitUserSelect:"none",userSelect:"none"},onMouseDown:n=>{n.button===2&&n.preventDefault()},children:[o.jsxs(h,{w:80,h:80,style:{borderRadius:12,backgroundColor:"rgb(116, 235, 213)",display:"flex",flexDirection:"column",justifyContent:"space-between",padding:"8px"},children:[y==="x"?o.jsx("input",{type:"number",style:{width:"100%",height:"24px",border:"1px solid #ddd",borderRadius:"4px",outline:"none",textAlign:"center",fontSize:"14px",padding:"0 4px",backgroundColor:"#fff",transition:"border-color 0.2s"},value:f,onChange:n=>{i(parseInt(n.target.value))},onBlur:()=>{l("none"),r.onChange?.(f,s),t.shouldAutoFocusPositionMacro=!1},onKeyDown:n=>{n.key==="Enter"&&(l("none"),r.onChange?.(f,s),t.shouldAutoFocusPositionMacro=!1)},onFocus:n=>{n.target.style.borderColor="var(--color-highlight-2)",n.target.style.boxShadow="0 0 0 2px rgba(24, 144, 255, 0.2)"},onMouseEnter:n=>{n.target instanceof HTMLInputElement&&(n.target.style.borderColor="var(--color-highlight-2)")},onMouseLeave:n=>{document.activeElement!==n.target&&n.target instanceof HTMLInputElement&&(n.target.style.borderColor="#ddd")},autoFocus:!0}):o.jsxs(h,{id:"value-display-x",style:{fontSize:"14px",color:"#333",cursor:"text",padding:"4px 8px",borderRadius:"4px",backgroundColor:"transparent",transition:"all 0.2s",textAlign:"center"},onMouseEnter:n=>{n.currentTarget.style.backgroundColor="rgba(0,0,0,0.05)",n.currentTarget.style.boxShadow="0 0 0 1px rgba(0,0,0,0.1)"},onMouseLeave:n=>{n.currentTarget.style.backgroundColor="transparent",n.currentTarget.style.boxShadow="none"},children:["X: ",r.x]}),o.jsx(h,{w:"full",h:1,style:{backgroundColor:"#333",margin:"8px 0"}}),y==="y"?o.jsx("input",{type:"number",style:{width:"100%",height:"24px",border:"1px solid #ddd",borderRadius:"4px",outline:"none",textAlign:"center",fontSize:"14px",padding:"0 4px",backgroundColor:"#fff",transition:"border-color 0.2s"},value:s,onChange:n=>{S(parseInt(n.target.value))},onBlur:()=>{l("none"),r.onChange?.(f,s)},onKeyDown:n=>{n.key==="Enter"&&(l("none"),r.onChange?.(f,s))},onFocus:n=>{n.target.style.borderColor="var(--color-highlight-2)",n.target.style.boxShadow="0 0 0 2px rgba(24, 144, 255, 0.2)"},onMouseEnter:n=>{n.target instanceof HTMLInputElement&&(n.target.style.borderColor="var(--color-highlight-2)")},onMouseLeave:n=>{document.activeElement!==n.target&&n.target instanceof HTMLInputElement&&(n.target.style.borderColor="#ddd")},autoFocus:!0}):o.jsxs(h,{id:"value-display-y",style:{fontSize:"14px",color:"#333",cursor:"text",padding:"4px 8px",borderRadius:"4px",backgroundColor:"transparent",transition:"all 0.2s",textAlign:"center"},onMouseEnter:n=>{n.currentTarget.style.backgroundColor="rgba(0,0,0,0.05)",n.currentTarget.style.boxShadow="0 0 0 1px rgba(0,0,0,0.1)"},onMouseLeave:n=>{n.currentTarget.style.backgroundColor="transparent",n.currentTarget.style.boxShadow="none"},children:["Y: ",r.y]})]}),o.jsx(h,{divRef:e,w:0,h:0})]})},ke=r=>{re();const v=H();t.getCurrentDevice();const p=t.宏列表,e=t.currentSelectMacro,[c,C]=w.useState(!1),[y,l]=w.useState(r.name),[f,i]=w.useState(r.name),[s,S]=w.useState(!1),[n,E]=w.useState(null);w.useEffect(()=>(s&&(n&&clearTimeout(n),E(setTimeout(()=>{S(!1)},1e3))),()=>{n&&clearTimeout(n)}),[s]),w.useEffect(()=>{e.id===""&&(e.name=v.新的宏+"1")},[t.languageCode]),w.useEffect(()=>{i(r.name)},[r.name]);const L=()=>{if(f.length===0||f.trim()===""){ee.error(v.宏名称不能为空||"宏名称不能为空",t.toastOptions),i(y),C(!1);return}C(!1);const R=p.find(a=>a.id===r.id);R&&(R.name=f),N.setLocalStorage(N.WebLoaclKey.ALL_MACROS,p)},z=async()=>{const R=t.宏列表.findIndex(a=>a.id===r.id);if(R!==-1){t.宏列表.splice(R,1),N.setLocalStorage(N.WebLoaclKey.ALL_MACROS,t.宏列表),t.宏列表=[...t.宏列表];const a=await $.getAllImageLikeMacroItemsFromIotDb(),d=await $.getIotDbMacroIdByLocalStorageMacroId(r.id),b=a.find(k=>k.id===d);b&&await fe.deleteItem(b,te.DBPATH.MACRO,te.DBPATH.MACRO_BUFFER)&&T.next({type:"success",message:v.删除当前作品成功||"删除当前作品成功"})}};return o.jsxs(h,{w:"full",h:77,type:"左右___主轴居中",style:{background:"#FFFFFF",borderRadius:"12px",padding:"0 25px",border:e.id===r.id?"1px solid #4CAF50":"1px solid #E5E5E5",cursor:"pointer"},onClick:r.clickHandler,children:[o.jsx(h,{type:"左右___主轴居中",style:{gap:"8px"},children:c?o.jsx("input",{value:f,onChange:R=>{const a=R.target.value;if(a.length>20){s||(ee.error(v.宏名称最多20个字符||"宏名称最多20个字符",t.toastOptions),S(!0));return}i(a)},onKeyDown:R=>{R.key==="Enter"&&L()},onBlur:()=>{L()},autoFocus:!0,style:{fontSize:"16px",color:"#333333",border:"1px solid #E5E5E5",borderRadius:"4px",padding:"4px 8px"}}):o.jsx(h,{style:{fontSize:"16px",color:"#333333"},children:r.name})}),o.jsxs(h,{style:{marginLeft:"auto",display:"flex",gap:"12px"},children:[o.jsx(I,{disabled:t.宏编辑.isRecord!=="stop",type:"宏编辑",onClick:()=>{l(f),C(!0)}}),t.isUseIotSDK&&!t.companyConfig?.newSingleDriver&&o.jsx(I,{visibility:"visible",type:"分享",disabled:t.宏编辑.isRecord!=="stop",onClick:()=>{t.currentUser?t.showShareModal=!0:T.next({type:"info",message:v.请登陆后再尝试||"请登陆后再尝试"})}}),o.jsx(I,{disabled:t.宏编辑.isRecord!=="stop",type:"删除",onClick:async()=>{await z()}})]})]})};let j=0;const Le=()=>{re();const r=w.useRef(null),v=ae(r),p=H(),e=t.宏编辑||{},c=t.currentSelectMacro||{},C=t.宏列表||[],[y]=w.useState(new Map),[l,f]=w.useState(!1),[i,s]=w.useState({top:0,left:0});w.useEffect(()=>{(async()=>{(N.getLocalStorage(N.WebLoaclKey.ALL_MACROS)||[]).forEach(async b=>{b&&await $.saveLocalStorageMacroToIotDb(b)}),await $.syncIotDbMacrosToLocalStorage(),await $.getAllImageLikeMacroItemsFromIotDb()})()},[]),w.useEffect(()=>{c&&c?.event?.length>0&&c?.event[0]?.type==="delay"&&c.event.splice(0,1)},[c?.event?.length]),w.useEffect(()=>{const a=u=>{if(e.isRecord!=="start"||(u.preventDefault(),y.has(u.code)))return;const g=D.getEvent(u,"down",j);if(g.type!=="keyboard")return;const x=JSON.parse(JSON.stringify(t.currentSelectMacro.event));if(g.delay!==void 0&&x.push({type:"delay",delay:e.isFixed?e.fixedTime:g.delay}),x.push({type:"keyboard",keyCode:g.code,isDown:!0}),D.checkUiMacroListIsFull(x))return;t.currentSelectMacro.event=x;const M=Math.round(u.timeStamp);y.set(u.code,M),j=M},d=u=>{if(e.isRecord!=="start"||(u.preventDefault(),!y.has(u.code)))return;const g=D.getEvent(u,"up",j);if(g.type!=="keyboard")return;const x=JSON.parse(JSON.stringify(t.currentSelectMacro.event));g.delay!==void 0&&x.push({type:"delay",delay:e.isFixed?e.fixedTime:g.delay}),x.push({type:"keyboard",keyCode:g.code,isDown:!1}),!D.checkUiMacroListIsFull(x)&&(t.currentSelectMacro.event=x,y.delete(u.code),j=Math.round(u.timeStamp))},b=u=>{if(e.isRecord!=="start")return;u.preventDefault();const g=Math.round(u.timeStamp),x=D.getEvent(u,"down",j);if(x.type!=="mouse"||x.code===void 0||y.has(x.code))return;const M=JSON.parse(JSON.stringify(t.currentSelectMacro.event));x.delay!==void 0&&M.push({type:"delay",delay:e.isFixed?e.fixedTime:x.delay}),M.push({type:"mouse",keyCode:x.code,isDown:!0}),!D.checkUiMacroListIsFull(M)&&(t.currentSelectMacro.event=M,y.set(x.code,g),j=g)},k=u=>{if(e.isRecord!=="start")return;u.preventDefault();const g=D.getEvent(u,"down",j);if(g.type!=="mouse"||g.code===void 0||!y.has(g.code))return;const x=JSON.parse(JSON.stringify(t.currentSelectMacro.event));g.delay!==void 0&&x.push({type:"delay",delay:e.isFixed?e.fixedTime:g.delay}),x.push({type:"mouse",keyCode:g.code,isDown:!1}),!D.checkUiMacroListIsFull(x)&&(t.currentSelectMacro.event=x,y.delete(g.code),j=Math.round(u.timeStamp))},m=()=>{document.removeEventListener("keydown",a),document.removeEventListener("keyup",d),document.removeEventListener("mousedown",b),document.removeEventListener("mouseup",k)};return m(),document.addEventListener("keydown",a),document.addEventListener("keyup",d),document.addEventListener("mousedown",b),document.addEventListener("mouseup",k),()=>{m()}},[]);const S=()=>{const d=(C?.filter(k=>k.name.includes(p.新的宏))).map(k=>{const m=k.name.match(new RegExp(`${p.新的宏}(\\d+)`));return m?parseInt(m[1]):0});let b=1;for(;d.includes(b);)b++;return b};w.useEffect(()=>{y.clear(),j=0},[c.id]);const n=t.stopRecording,E=_(),[L,z]=w.useState(700);w.useEffect(()=>{if(!E.current)return;const a=new ResizeObserver(d=>{for(const b of d){const k=b.contentRect.height;k&&z(k)}});return E.current&&a.observe(E.current),()=>{a.disconnect()}},[E]);const R=async()=>{if(e?.isRecord!=="start"){if(C.length===0||t.currentSelectMacro.id===""){const b={id:crypto.randomUUID(),name:p.新的宏+S(),delay:1,loopTime:1,type:"循环次数",event:[]};t.宏列表.push(b),t.currentSelectMacro=b,N.setLocalStorage(N.WebLoaclKey.ALL_MACROS,t.宏列表)}j=0,y.clear();let a=t.currentSelectMacro.event.findIndex(d=>d.type==="editing");for(;a!==-1;)t.currentSelectMacro.event.splice(a,1),a=t.currentSelectMacro.event.findIndex(d=>d.type==="editing");e.isRecord="start"}else await n()};return w.useEffect(()=>{C.length>0?t.currentSelectMacro=C[0]:t.currentSelectMacro={id:"",name:p.新的宏+"1",delay:1,loopTime:1,event:[],type:"循环次数"}},[]),w.useEffect(()=>{C.length===0?t.currentSelectMacro={id:"",name:p.新的宏+"1",delay:1,loopTime:1,event:[],type:"循环次数"}:C.some(d=>d.id===c.id)||(t.currentSelectMacro=C[0])},[C.length]),o.jsxs(o.Fragment,{children:[o.jsxs(h,{id:"macro-editing-page-container",w:"full",h:"full",type:"左右",style:{padding:"1vh 1vw",paddingBottom:"0",boxSizing:"border-box",flex:"1 1 0%",maxHeight:"777px",justifyContent:"center",overflow:"auto"},children:[o.jsx(h,{w:15,h:"full",type:"上下___交叉轴居左"}),o.jsxs(h,{divRef:E,type:"上下",w:"90%",h:"full",style:{background:"rgb(255,255,255)",borderRadius:12,flex:"1 1 0%",maxHeight:"777px",minHeight:"0"},children:[o.jsxs(h,{w:"full",h:77,style:{background:"#3E3E3E",borderRadius:"12px 12px 0 0 ",padding:"0 25px"},children:[t.isUseIotSDK&&!t.companyConfig.newSingleDriver&&!le.isMousePage&&o.jsx(I,{disabled:e.isRecord!=="stop",style:{pointerEvents:e.isRecord!=="stop"?"none":"auto",opacity:e.isRecord!=="stop"?.5:1,cursor:e.isRecord!=="stop"?"not-allowed":"pointer"},type:"热门",text:p.热门||"热门",textColor:"white",onClick:()=>{if(e.isRecord!=="stop"){T.next({type:"error",message:p.请先停止录制||"请先停止录制"});return}t.currentHomePageIndex=ce.社区分享,t.current社区分享SubpageIndex=de.宏分享,t.state_communitySharingPage.redirectedFromMacroEditPage=!0}}),o.jsx(h,{style:{marginLeft:"auto"},children:o.jsx(I,{disabled:e.isRecord!=="stop",style:{pointerEvents:e.isRecord!=="stop"?"none":"auto",opacity:e.isRecord!=="stop"?.5:1,cursor:e.isRecord!=="stop"?"not-allowed":"pointer"},type:"添加宏",text:"新建宏",textSize:14,textColor:e.isRecord!=="stop"?"var(--color-text-not-selected)":"white",onClick:()=>{t.createMacro()}})})]}),o.jsx(ue,{ref:r,$isScrollbarHovered:v,id:"macro-list-container",style:{width:"100%",height:"100%",display:"flex",flexDirection:"column",padding:"12px 43px",gap:"12px"},children:C?.map((a,d)=>a.id?o.jsx(ke,{name:a.name,clickHandler:()=>{if(e.isRecord!=="stop"){T.next({type:"error",message:p.请先停止录制||"请先停止录制"});return}t.currentSelectMacro=a},id:a.id?.toString()},a.id):null)})]}),o.jsx(h,{w:15,h:"full",type:"上下___交叉轴居左"}),o.jsxs(h,{id:"right-container",type:"上下___交叉轴居左",w:"50%",h:"full",style:{flex:"1 1 0%",gap:"10px",justifyContent:"center",maxHeight:"777px",minHeight:"0"},children:[o.jsxs(h,{w:"full",style:{flex:"1 1 62px",background:"#fff",borderRadius:12,gap:"1vw",padding:"0.5vh 1vw",flexWrap:"wrap"},children:[o.jsxs(h,{children:[o.jsx(G,{disabled:e.isRecord!=="stop",textColor:"var(--color-text-dark)",style:{fontSize:14,fontFamily:"var(--font-family-regular)"},isSelected:t.currentSelectMacro.type==="循环次数",onClick:()=>{if(e.isRecord!=="stop"){T.next({type:"error",message:p.请先停止录制||"请先停止录制"});return}t.currentSelectMacro.type="循环次数"},text:"循环次数"}),o.jsx(Q,{range:{min:1,max:65535},disabled:t.currentSelectMacro?.type!=="循环次数"||e.isRecord!=="stop",value:t.currentSelectMacro?.loopTime??1,onChange:a=>{t.currentSelectMacro&&(t.currentSelectMacro.loopTime=a)}})]}),o.jsx(G,{disabled:e.isRecord!=="stop",style:{fontSize:14,fontFamily:"var(--font-family-regular)"},isSelected:t.currentSelectMacro.type==="使用指派按键切换开/关播放",onClick:()=>{if(e.isRecord!=="stop"){T.next({type:"error",message:p.请先停止录制||"请先停止录制"});return}t.currentSelectMacro.type="使用指派按键切换开/关播放"},text:"使用指派按键切换开关播放"}),o.jsx(G,{disabled:e.isRecord!=="stop",style:{fontSize:14,fontFamily:"var(--font-family-regular)"},isSelected:t.currentSelectMacro.type==="按下播放",onClick:()=>{if(e.isRecord!=="stop"){T.next({type:"error",message:p.请先停止录制||"请先停止录制"});return}t.currentSelectMacro.type="按下播放"},text:"按下播放"})]}),o.jsxs(h,{id:"macro-events-container",type:"上下",w:"full",h:L-77,style:{background:"rgb(255,255,255)",borderRadius:12,overflowY:"auto",minHeight:L-77},children:[o.jsxs(h,{w:"full",style:{maxHeight:"fit-content",background:"#3E3E3E",borderRadius:"12px 12px 0 0 ",padding:"10px 25px",justifyContent:"space-around",flexWrap:"wrap"},children:[o.jsx(I,{disabled:e?.isRecord==="single",style:{pointerEvents:e?.isRecord==="single"?"none":"auto",opacity:e?.isRecord==="single"?.5:1,cursor:e?.isRecord==="single"?"not-allowed":"pointer"},type:e?.isRecord==="start"?"停止录制":"开始录制",text:e?.isRecord==="start"?"结束录制":"开始录制",textSize:14,textColor:"white",stopMouseDownEventPropagation:!0,onClick:async()=>{await R()}}),o.jsx(I,{disabled:e.isRecord!=="stop",style:{pointerEvents:e.isRecord!=="stop"?"none":"auto",opacity:e.isRecord!=="stop"?.5:1,cursor:e.isRecord!=="stop"?"not-allowed":"pointer"},type:"添加",text:"添加",textSize:14,textColor:e.isRecord!=="stop"?"var(--color-text-not-selected)":"white",stopMouseDownEventPropagation:!0,onClick:a=>{if(e.isRecord!=="stop"){T.next({type:"error",message:p.请先停止录制||"请先停止录制"});return}if(a){const d=a.currentTarget.getBoundingClientRect();s({top:d.bottom,left:d.left}),f(!0)}}}),l&&o.jsxs("div",{style:{position:"fixed",top:i.top,left:i.left,backgroundColor:"var(--color-background-white)",borderRadius:"8px",boxShadow:"0px 4px 8px rgba(0, 0, 0, 0.2)",zIndex:1e3,padding:"0 8px"},children:[o.jsx("div",{style:{padding:"8px 16px",color:"var(--color-text-dark)",cursor:"pointer",borderBottom:"1px solid var(--color-text-dark)"},onClick:async()=>{f(!1),await n(!1),e.isRecord="single",c.event.push({type:"editing",action:"keyboard"});const a=async b=>{if(b.preventDefault(),b.stopPropagation(),(b.button===3||b.button===4)&&b.preventDefault(),document.removeEventListener("keydown",d),document.removeEventListener("mousedown",a),e.isRecord!=="single")return;const k=t.currentSelectMacro.event[t.currentSelectMacro.event.length-1],m=D.getEvent(b,"down",0);if(k.type==="editing"&&m.type==="mouse"&&m.code!==void 0){c.event.splice(c.event.length-1,1);const u=e.isFixed?e.fixedTime:50;t.currentSelectMacro.event.push({type:"mouse",keyCode:m.code,isDown:!0},{type:"delay",delay:u},{type:"mouse",keyCode:m.code,isDown:!1},{type:"delay",delay:u})}await t.stopRecording(!1)},d=b=>{if(b.preventDefault(),document.removeEventListener("keydown",d),document.removeEventListener("mousedown",a),e.isRecord!=="single")return;const k=t.currentSelectMacro.event[t.currentSelectMacro.event.length-1],m=D.getEvent(b,"down",0);if(k.type==="editing"&&m.type==="keyboard"){c.event.splice(c.event.length-1,1);const u=e.isFixed?e.fixedTime:50;t.currentSelectMacro.event.push({type:"keyboard",keyCode:m.code,isDown:!0},{type:"delay",delay:u},{type:"keyboard",keyCode:m.code,isDown:!1},{type:"delay",delay:u})}t.stopRecording(!1)};document.addEventListener("keydown",d),document.addEventListener("mousedown",a)},children:p.按键}),o.jsx("div",{style:{padding:"8px 16px",color:"var(--color-text-dark)",cursor:"pointer"},onClick:async()=>{f(!1),await n(!1),t.shouldAutoFocusPositionMacro=!0;const a={type:"position",x:0,y:0};c.event.push(a,{type:"delay",delay:e.isFixed?e.fixedTime:50})},children:p.坐标})]}),l&&o.jsx("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:999},onClick:()=>f(!1)}),o.jsx(I,{disabled:e.isRecord!=="stop",style:{pointerEvents:e.isRecord!=="stop"?"none":"auto",opacity:e.isRecord!=="stop"?.5:1,cursor:e.isRecord!=="stop"?"not-allowed":"pointer"},type:"清空",text:"清空",textSize:14,textColor:e.isRecord!=="stop"?"var(--color-text-not-selected)":"white",stopMouseDownEventPropagation:!0,onClick:a=>{if(e.isRecord!=="stop"){T.next({type:"error",message:p.请先停止录制||"请先停止录制"});return}c.event=[]}}),o.jsxs(h,{children:[o.jsx(pe,{value:e.isFixed,onChange:a=>{e.isFixed=a},disabled:e.isRecord!=="stop"}),o.jsx(Z,{type:"正文内容_黑底白字",text:p.固定间隔,onClick:()=>{if(e.isRecord!=="stop"){T.next({type:"error",message:p.请先停止录制||"请先停止录制"});return}e.isFixed=!e.isFixed},style:{fontSize:14,fontFamily:"var(--font-family-regular)",padding:"0 10px",cursor:e.isRecord==="stop"?"pointer":"not-allowed",pointerEvents:e.isRecord==="stop"?"auto":"none",opacity:e.isRecord==="stop"?1:.5},hoverStyle:{color:"var(--color-highlight-2)"}}),o.jsx(Q,{range:{min:0,max:65535},disabled:e.isFixed===!1||e.isRecord!=="stop",value:e.fixedTime,onChange:a=>{a>65535?e.fixedTime=65535:e.fixedTime=a}}),o.jsx("div",{style:{color:"white",paddingLeft:10},children:"ms"})]}),o.jsx(I,{disabled:e.isRecord==="start",style:{cursor:e.isRecord==="start"?"not-allowed":"pointer",pointerEvents:e.isRecord==="start"?"none":"auto",opacity:e.isRecord==="start"?.5:1},type:"保存",text:"保存",textSize:14,textColor:e.isRecord==="start"?"var(--color-text-not-selected)":"white",stopMouseDownEventPropagation:e.isRecord==="start",onClick:async()=>{await t.saveMacro()}})]}),o.jsx(h,{type:"左右",w:"full",style:{justifyContent:"flex-end",padding:"5px 25px"},children:o.jsx(Z,{type:"提示文本",text:p.设置完成之后请点击保存按钮保存宏,style:{fontSize:12,fontFamily:"var(--font-family-regular)"}})}),o.jsx(ye,{autoScroll:e.isRecord!=="stop",children:t.currentSelectMacro?.event?.map((a,d)=>{const b=(m,u,g=!1)=>{e.isRecord="single";const x=async P=>{if(P.preventDefault(),document.removeEventListener("keydown",x),document.removeEventListener("mousedown",M),e.isRecord!=="single")return;const q=c.event[u],A=D.getEvent(P,"down",0);if(q.type==="editing"&&A.type==="keyboard"){const O=e.isFixed?e.fixedTime:50;c.event.splice(u,1,{type:"keyboard",keyCode:A.code,isDown:!0},{type:"delay",delay:O},{type:"keyboard",keyCode:A.code,isDown:!1},{type:"delay",delay:O});const F=c.event;if(u+3<F.length){const B=F[u+3];if(B?.type==="delay"&&u+4<F.length){const K=F[u+4];K?.type==="delay"&&(B.delay+=K.delay,F.splice(u+4,1))}}}await n(!1)},M=async P=>{if(P.preventDefault(),document.removeEventListener("keydown",x),document.removeEventListener("mousedown",M),e.isRecord!=="single")return;const q=c.event[u],A=D.getEvent(P,"down",0);if(q.type==="editing"&&A.type==="mouse"&&A.code!==void 0){const O=e.isFixed?e.fixedTime:50;c.event.splice(u,1,{type:"mouse",keyCode:A.code,isDown:!0},{type:"delay",delay:O},{type:"mouse",keyCode:A.code,isDown:!1},{type:"delay",delay:O});const F=c.event;if(u+3<F.length){const B=F[u+3];if(B?.type==="delay"&&u+4<F.length){const K=F[u+4];K?.type==="delay"&&(B.delay+=K.delay,F.splice(u+4,1))}}}await n()};document.addEventListener("keydown",x),document.addEventListener("mousedown",M)},k=m=>{const u=a.type==="delay"?d+1:d+2;if(m==="key"){const g={type:"editing",action:"keyboard"};c.event.splice(u,0,g),b(!0,u,!0)}if(m==="delay"){const x={type:"delay",delay:e.isFixed?e.fixedTime:50};c.event.splice(u,0,x)}if(m==="position"){const g={type:"position",x:0,y:0};c.event.splice(u,0,g,{type:"delay",delay:e.isFixed?e.fixedTime:50})}};return a.type==="editing"?o.jsx(oe,{onChange:()=>{c.event.splice(d,1,{type:"editing",action:"keyboard"}),b(!0,d)},onDelete:()=>{c.event.splice(d,1)},onAddEvent:m=>{m==="position"&&(t.shouldAutoFocusPositionMacro=!0),k(m)}},d):a.type==="keyboard"?o.jsx(oe,{value:a.keyCode,isDown:a.isDown,onChange:()=>{c.event.splice(d,1,{type:"editing",action:"keyboard"}),b(!0,d)},onDelete:()=>{c.event.splice(d,2)},onAddEvent:m=>{m==="position"&&(t.shouldAutoFocusPositionMacro=!0),k(m)}},d):a.type==="mouse"?o.jsx(we,{macroMouseType:a.keyCode,isDown:a.isDown,onChange:()=>{c.event.splice(d,1,{type:"editing",action:"mouse"}),b(!1,d)},onDelete:()=>{c.event.splice(d,2)},onAddEvent:m=>{m==="position"&&(t.shouldAutoFocusPositionMacro=!0),k(m)}},d):a.type==="delay"?o.jsx(Se,{value:a.delay,onChange:m=>{const u=typeof m=="number"?m:parseInt(String(m),10)||0;a.delay=u;const g=c.event,x=d>0?g[d-1]:null,M=d<g.length-1?g[d+1]:null;if(x?.type==="delay"){x.delay+=u,g.splice(d,1);return}if(M?.type==="delay"){M.delay+=u,g.splice(d,1);return}},onDelete:()=>{c.event.splice(d-1,2)},onAddEvent:m=>{m==="position"&&(t.shouldAutoFocusPositionMacro=!0),k(m)}},d):a.type==="position"?o.jsx(Ce,{x:a.x,y:a.y,onChange:(m,u)=>{let g=m.toString().replace(/[^\-\d]/g,"");g=g.replace(/\-{2,}/g,"-"),g=g.replace(/(\d)\-/g,"$1"),g=g.replace(/^0+(\d+)/,"$1"),g=g.replace(/(-)0+(\d+)/g,"$1$2"),Number(g)>127?g=127 .toString():Number(g)<-127?g=(-127).toString():g=g,a.x=Number(g);let x=u.toString().replace(/[^\-\d]/g,"");x=x.replace(/\-{2,}/g,"-"),x=x.replace(/(\d)\-/g,"$1"),x=x.replace(/^0+(\d+)/,"$1"),x=x.replace(/(-)0+(\d+)/g,"$1$2"),Number(x)>127?x=127 .toString():Number(x)<-127?x=(-127).toString():x=x,a.y=Number(x)},onDelete:()=>{c.event.splice(d,2)},onAddEvent:m=>{m==="position"&&(t.shouldAutoFocusPositionMacro=!0),k(m)}},d):o.jsx(o.Fragment,{})})})]})]}),o.jsx(h,{w:15,h:"full",type:"上下___交叉轴居左"})]}),o.jsx(xe,{show:t.showShareModal,type:"macro",name:t.currentSelectMacro?.name??"",onCancel:()=>{t.showShareModal=!1},onConfirm:a=>{t.showShareModal=!1,t.handleShareMacro(t.currentSelectMacro,a.description??"")},disableButtons:t.isWaitingServerResponse})]})};export{Le as Page_宏编辑页};
