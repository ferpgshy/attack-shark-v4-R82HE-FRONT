import{N as O,ai as r,al as u,an as p}from"./index.b078bf5f.js";import{CommonDongle as w}from"./f92a5af8.js";class T extends w{getOLEDDataDirection=()=>"row";getUSBVersion=async()=>{const i=O.devlistList.find(e=>e.oneofDev.oneofKind==="dangleCommonDev"&&(e.oneofDev.dangleCommonDev.pid===20544||e.oneofDev.dangleCommonDev.pid===20555)&&e.oneofDev.dangleCommonDev.vid===12625);let t;if(i!=null&&i.oneofDev.oneofKind==="dangleCommonDev"){const e=i.oneofDev.dangleCommonDev?.path;t=await this.commonMsgByPath(new Uint8Array([240]),r.Bit7,e,5,0)}return t==null?0:t[1]<<8|t[0]};FEA_CMD_GETOLED_VERSION=173;getOledVersion=async()=>{const i=await this.commonRawMsg(new Uint8Array([this.FEA_CMD_GETOLED_VERSION]),r.Bit7,10,100);if(i===void 0||i[0]!==this.FEA_CMD_GETOLED_VERSION)return;const t=new DataView(i.buffer,i.byteOffset,i.byteLength);return{oledVersion:t.getUint16(1,!0),flashVersion:t.getUint16(3,!0)}};getRFVersion=async()=>0;rfUpgrade=async(i,t)=>!1;BOOT_INFOS=[{vid:12625,pid:20542},{vid:12625,pid:20550}];findSameDevPath=async i=>{let t=0,e;for(;e===void 0&&t<10;){await u(2e3);const n=O.devlistList.find(a=>a.oneofDev.oneofKind==="dangleCommonDev"&&(a.oneofDev.dangleCommonDev.path===this.deviceType.devAddr||(a.oneofDev.dangleCommonDev.pid===20544||a.oneofDev.dangleCommonDev.pid===20555)&&a.oneofDev.dangleCommonDev.vid===12625));e=n?.oneofDev.oneofKind==="dangleCommonDev"?n.oneofDev.dangleCommonDev.path:void 0,t++}if(e!==void 0)return e};FEA_CMD_SET_OLEDBOOTLOADER=48;FEA_CMD_GET_OLEDBOOTLOADER=176;FEA_CMD_SET_OLEDBOOTSTART=49;FEA_CMD_GET_OLEDBOOTCHECKSUM=177;oledUpgrade=async(i,t)=>{t(0);const e=await this.findSameDevPath();if(e===void 0||!await this.sendMsgByPath(new Uint8Array([this.FEA_CMD_SET_OLEDBOOTLOADER,85,170,85,170,0,0,0]),r.Bit7,e))return!1;let a=0,l=!1;for(;!l&&a<5;){await u(1e3*3);const s=await this.commonMsgByPath(new Uint8Array([this.FEA_CMD_GET_OLEDBOOTLOADER]),r.Bit7,e,10,100);l=s!==void 0&&s[0]===this.FEA_CMD_GET_OLEDBOOTLOADER,a++}const f=i.slice(65536),d=64,v=Math.ceil(f.length/d),m=new Uint8Array(2);m[0]=v&255,m[1]=v>>8,await this.sendMsgByPath(new Uint8Array([this.FEA_CMD_SET_OLEDBOOTSTART,...m]),r.Bit7,e);let h=0;for(let s=0;s<v;s++){const E=s*d>f.length?d-(s*d-f.length):d,o=f.slice(s*d,s*d+E),_=await this.sendMsgByPath(o,r.None,e);for(let g=0;g<o.length;g++)h+=o[g];if(_)t(s/v);else return t(1),!1}const D=new Uint8Array(4);D[0]=h&255,D[1]=(h&65280)>>8,D[2]=(h&16711680)>>16,D[3]=(h&4278190080)>>24;const c=await this.commonMsgByPath(new Uint8Array([this.FEA_CMD_GET_OLEDBOOTCHECKSUM,...D]),r.Bit7,e,10,1e3*1);return t(1),c!==void 0&&c[1]===85};boot_usb=async()=>{if(this.BOOT_INFOS.some(n=>n.vid===this.deviceType.vid&&n.pid===this.deviceType.pid))return this.deviceType.devAddr.toString();const i=O.devlistList.find(n=>n.oneofDev.oneofKind==="dangleCommonDev"&&(n.oneofDev.dangleCommonDev.pid===20544||n.oneofDev.dangleCommonDev.pid===20555)&&n.oneofDev.dangleCommonDev.vid===12625);if(i!=null&&i.oneofDev.oneofKind==="dangleCommonDev"){const n=i.oneofDev.dangleCommonDev?.path;await this.sendMsgByPath(new Uint8Array([127,85,170,85,170]),r.Bit7,n)}await u(1e3*1);let t=0,e;for(;e===void 0&&t<100;)await u(500),e=O.devlistList.find(n=>n.oneofDev.oneofKind==="dev"&&(n.oneofDev.dev.path===this.deviceType.devAddr||(n.oneofDev.dev.pid===20542||n.oneofDev.dev.pid===20550)&&n.oneofDev.dev.vid===12625)),t++;if(!(e===void 0||e.oneofDev.oneofKind!=="dev"))return e.oneofDev.dev.path};upgrade=async(i,t)=>{t(0);const e=await this.boot_usb();if(e===void 0)return!1;const n=i.slice(20480),a=64,l=Math.ceil(n.length/a),f=new Uint8Array(2);f[0]=l&255,f[1]=l>>8;const d=new Uint8Array(4);d[0]=n.length&255,d[1]=(n.length&65280)>>8,d[2]=(n.length&16711680)>>16,d[3]=(n.length&4278190080)>>24;const v=[186,192];f.map(o=>v.push(o)),d.slice(0,3).map(o=>v.push(o));let m,h=0;for(;m===void 0&&h<10;)m=await this.commonMsgByPath(new Uint8Array(v),r.None,e),h++,await u(50);if(m===void 0)return!1;for(let o=0;o<l;o++){const _=o*a>n.length?a-(o*a-n.length):a,g=n.slice(o*a,o*a+_);if(!await this.sendMsgByPath(g,r.None,e))return!1;t(o/l)}const D=p([...n]),c=new Uint8Array(4);c[0]=D&255,c[1]=(D&65280)>>8,c[2]=(D&16711680)>>16,c[3]=(D&4278190080)>>24;const s=[186,194];f.map(o=>s.push(o)),c.map(o=>s.push(o)),d.map(o=>s.push(o));const E=await this.commonMsgByPath(new Uint8Array(s),r.None,e,50,10);return E!==void 0&&E[4]===85}}export{T as CommonDgCh585};
